# -*- mode: shell-script -*-

src_file=../src/lib/libpretty.sh

prefix_cmd="
. /etc/shlib

source '$src_file'
pretty:init
"

export COLUMNS=50


##
## Elt
##

try 'Wrap "true"' \
    'with color: "Wrap true" expected sequence of output'
noerror
is out "- true
- true                                         W
- true                                [  OK  ] W" NOCOLOR NOPOS TRIM

try 'Wrap "false"' \
    'with color: "Wrap false" expected sequence of output'
is errlvl 1
is out reg "^- false
- false                                        W
- false                               \[FAILED\] W
Error in wrapped command:
pwd: [^$NL]+
code:
\| false
output \(1\):" NOCOLOR NOPOS TRIM

try 'Wrap -q "true"' \
    'Bare "Wrap true" with quiet mode'
noerror
is out ""

try 'Wrap -q "false"' \
    'Bare "Wrap false" with quiet mode'
is errlvl 1
is out reg "\
Error in wrapped command:
 pwd: [^$NL]+
 code:
  \| false
 output \(1\):
" NOCOLOR

try 'Wrap -d "My command"  "true"' \
    'Bare "Wrap true" with description'
noerror
is out "- My command
- My command                                   W
- My command                          [  OK  ] W" NOPOS NOCOLOR TRIM

try 'Wrap -d "My command" "false"' \
    'Bare wrap with description mode'
is errlvl 1
is out reg "- My command
- My command                                   W
- My command                          \[FAILED\] W
Error in wrapped command:
pwd: [^$NL]+
code:
\| false
output \(1\):" NOCOLOR NOPOS TRIM

try 'Wrap -q -d "My successful command" "true"' \
    'Description "Wrap true" with quiet mode'
noerror
is out "" TRIM

try 'Wrap -q -d "My failing command" "false"' \
    'Description "Wrap false" with quiet mode'
is out reg "\
Error in wrapped command:
pwd: [^$NL]+
code:
| false
output (1):" NOCOLOR TRIM


try 'Wrap -qd "My failing command" "false"' \
    'support of aggregated single chars options'
is out reg "\
Error in wrapped command:
pwd: [^$NL]+
code:
| false
output (1):" NOCOLOR TRIM


try 'Wrap -qd="My failing command" "false"' \
    'support of "=" usage for specifying option values'
is out reg "\
Error in wrapped command:
pwd: [^$NL]+
code:
| false
output (1):" NOCOLOR TRIM

try 'Wrap -qd="My failing command" -- "false -d -q "' \
    'support of -- for not interpreting remainder of command line'
is out reg "\
Error in wrapped command:
pwd: [^$NL]+
code:
| false -d -q
output (1):" NOCOLOR TRIM


##
## EOF Mode
##

try 'Wrap -q -d "My failing command" <<EOF

false &&
false &&
false

EOF' \
    'stdin Wrap with description and quiet mode'
is out reg "\
Error in wrapped command:
pwd: [^$NL]*
code:
|
| false &&
| false &&
| false
output (1):" NOCOLOR TRIM

try 'Wrap -q -d "My successful command" <<EOF

false ||
false ||
true

EOF' \
    'Description Wrap succeeding with quiet mode'
is out "" NOCOLOR TRIM


##
## Wrapped Elt should not collide
##

try '
ansi_color yes
Wrap -d "Inbed Elt" <<EOF

. /etc/shlib

source '$src_file'
pretty:init

ansi_color yes
print_info_char "*"
Elt Hello; Feed
false

EOF' \
    'Elt in Wrap should not collide'
is errlvl 1
is err ""
is out "\
- Inbed Elt
- Inbed Elt                                    W
- Inbed Elt                           [FAILED] W
Error in wrapped command:
pwd: /home/vaab/dev/sh/kal-shlib-pretty/test
code:
|
| . /etc/shlib
|
| source ../src/lib/libpretty.sh
| pretty:init
|
| ansi_color yes
| print_info_char \"*\"
| Elt Hello; Feed
| false
output (1):
|  -                                          *
|  - Hello                                    *" NOCOLOR NOPOS TRIM



##
## Wrapped Elt should use a smaller full line
##

try '
ansi_color no
Wrap -d "Inbed Elt" <<EOF

. /etc/shlib

source '$src_file'
pretty:init

Elt Toto
print_info foo
print_status success
Feed
Wrap -d "inner Wrap" true
false
EOF' \
    'Wrap in wrap gets smaller line'
is errlvl 1
is err ""
is out "\
 - Inbed Elt                           [FAILED] W
Error in wrapped command:
 pwd: /home/vaab/dev/sh/kal-shlib-pretty/test
 code:
  |
  | . /etc/shlib
  |
  | source ../src/lib/libpretty.sh
  | pretty:init
  |
  | Elt Toto
  | print_info foo
  | print_status success
  | Feed
  | Wrap -d \"inner Wrap\" true
  | false
 output (1):
  |  - Toto       foo                  [  OK  ]
  |  - inner Wrap                      [  OK  ] W" RTRIM
